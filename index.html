<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Lesson Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  
  <!-- Fonts & Icons -->
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Nunito:wght@600;700&display=swap");
    @import url("https://unpkg.com/@phosphor-icons/web@2.1.1/src/css/phosphor.css");

    :root {
      --blue: #007bb4;
      --blue-strong: #006694;
      --green: #00833d;
      --green-dark: #006d34;
      --red: #d32f2f;
      --surface: #f7fbff;
      --ink: #0b2a3c;
      --muted: #6b7a86;
      --card: #ffffff;
      --shadow: 0 10px 30px rgba(0, 59, 92, 0.12);
      --radius: 18px;
      --nav-height: 74px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      background: radial-gradient(circle at 10% 10%, rgba(0, 123, 180, 0.05) 0%, transparent 40%),
                  radial-gradient(circle at 90% 90%, rgba(0, 131, 61, 0.05) 0%, transparent 40%),
                  var(--surface);
      font-family: 'Nunito', sans-serif;
      color: var(--ink);
      padding-bottom: calc(var(--nav-height) + 20px);
      min-height: 100vh;
    }

    /* --- Layout Components --- */
    .app-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      margin-bottom: 24px;
    }

    .pill {
      display: inline-block;
      background: rgba(0, 123, 180, 0.1);
      color: var(--blue-strong);
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 700;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--ink) 0%, var(--blue-strong) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* --- Date Controls --- */
    .date-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--card);
      padding: 8px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      margin-bottom: 24px;
    }

    .icon-btn {
      background: none;
      border: none;
      color: var(--blue);
      font-size: 24px;
      padding: 8px;
      cursor: pointer;
      border-radius: 50%;
      transition: background 0.2s;
    }
    .icon-btn:hover { background: rgba(0,123,180,0.1); }

    input[type="date"] {
      border: none;
      font-family: 'Nunito', sans-serif;
      font-size: 16px;
      font-weight: 700;
      color: var(--ink);
      background: transparent;
      text-align: center;
    }

    /* --- Tables --- */
    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.5);
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th {
      text-align: left;
      padding: 16px;
      background: rgba(0, 123, 180, 0.03);
      color: var(--muted);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    .data-table td {
      padding: 16px;
      border-bottom: 1px solid rgba(0,0,0,0.04);
      vertical-align: top;
      font-size: 0.95rem;
    }
    
    .data-table tr:last-child td { border-bottom: none; }

    .name-text {
      color: var(--blue-strong);
      font-weight: 700;
      display: block;
    }

    .sub-text {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 4px;
    }

    /* --- Attendance Specifics --- */
    .attendance-btn {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      border: 2px solid #eee;
      background: #fff;
      color: #ccc;
      font-size: 20px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      margin-right: 8px;
    }

    .attendance-btn.active {
      background: var(--green);
      border-color: var(--green);
      color: white;
      transform: scale(1.05);
      box-shadow: 0 4px 10px rgba(0, 131, 61, 0.3);
    }
    
    .attendance-btn.noshow {
       border-color: var(--red);
       color: var(--red);
    }

    /* --- Navigation Bar --- */
    .bottom-nav {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding: 8px;
      border-radius: 24px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      display: flex;
      gap: 8px;
      z-index: 100;
      border: 1px solid rgba(255,255,255,0.4);
    }

    .nav-item {
      padding: 12px 24px;
      border-radius: 16px;
      border: none;
      background: transparent;
      color: var(--muted);
      font-family: inherit;
      font-weight: 700;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-item.active {
      background: var(--ink);
      color: white;
      box-shadow: 0 4px 12px rgba(11, 42, 60, 0.2);
    }

    /* --- Buttons --- */
    .action-bar {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 16px;
    }

    .btn {
      padding: 14px;
      border-radius: 14px;
      border: none;
      font-family: inherit;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: transform 0.1s;
    }
    .btn:active { transform: scale(0.98); }

    .btn-primary {
      background: linear-gradient(145deg, var(--green), var(--green-dark));
      color: white;
      box-shadow: 0 8px 20px rgba(0, 131, 61, 0.25);
    }

    .btn-secondary {
      background: transparent;
      border: 2px solid rgba(11, 42, 60, 0.1);
      color: var(--ink);
    }

    /* --- Utilities --- */
    .hidden { display: none !important; }
    
    .loading-overlay {
      position: fixed;
      top:0; left:0; right:0; bottom:0;
      background: rgba(255,255,255,0.8);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 15px;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--blue);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--ink);
      color: white;
      padding: 12px 24px;
      border-radius: 50px;
      font-size: 0.9rem;
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s;
      z-index: 300;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    
    .pull-indicator {
      text-align: center;
      height: 0;
      overflow: hidden;
      color: var(--blue);
      transition: height 0.2s;
    }
    body.pull-refresh-ready .pull-indicator { height: 40px; }

  </style>
</head>
<body>

  <!-- Loading Overlay -->
  <div id="loading" class="loading-overlay hidden">
    <div class="spinner"></div>
    <div style="font-weight:700; color:var(--blue);">Loading...</div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast">Action Successful</div>

  <!-- Refresh Indicator -->
  <div class="pull-indicator"><i class="ph ph-arrow-clockwise" style="margin-top:10px; font-size:20px;"></i></div>

  <div class="app-container">
    
    <!-- Header & Date Controls -->
    <div class="header">
      <div>
        <span id="pagePill" class="pill">Overview</span>
        <h1 id="pageTitle">Schedule</h1>
      </div>
    </div>

    <div class="date-controls">
      <button class="icon-btn" id="prevDate"><i class="ph ph-caret-left"></i></button>
      <input type="date" id="dateInput">
      <button class="icon-btn" id="nextDate"><i class="ph ph-caret-right"></i></button>
    </div>

    <!-- VIEW: Schedule -->
    <div id="view-schedule" class="view-section">
      <div class="card">
        <table class="data-table" id="scheduleTable">
          <thead>
            <tr>
              <th>Time</th>
              <th>Student</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody id="scheduleBody"></tbody>
        </table>
      </div>
    </div>

    <!-- VIEW: Attendance -->
    <div id="view-attendance" class="view-section hidden">
      <div class="card">
        <table class="data-table" id="attendanceTable">
          <thead>
            <tr>
              <th>Time</th>
              <th>Attendance</th>
            </tr>
          </thead>
          <tbody id="attendanceBody"></tbody>
        </table>
      </div>
      <div class="action-bar">
        <button class="btn btn-secondary" id="resetBtn">Reset</button>
        <button class="btn btn-primary" id="submitBtn">Submit</button>
      </div>
    </div>

  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <button class="nav-item active" data-target="schedule">
      <i class="ph ph-calendar"></i> Schedule
    </button>
    <button class="nav-item" data-target="attendance">
      <i class="ph ph-check-circle"></i> Attendance
    </button>
  </nav>

  <script>
    /** * CONFIGURATION & CONSTANTS
     */
    const CONFIG = {
      clientId: "ixG6UsN5JaLPYFgwjhTAtmdg8UNU7IZYK2lOxTo3",
      apiBase: "https://mcdonaldswimschool.pike13.com/api/v2/desk/",
      excludedIds: [11485475, 11559838, 13602611, 13167161]
    };

    /** * STATE MANAGEMENT
     */
    const STATE = {
      schedule: [], // Raw processed schedule data
      currentDate: new Date().toISOString().split('T')[0], // YYYY-MM-DD
      view: 'schedule', // 'schedule' or 'attendance'
      pendingAttendance: {} // Local changes before submit
    };

    /** * AUTHENTICATION SERVICE
     */
    const Auth = {
      getToken() {
        return localStorage.getItem("access_token");
      },
      
      init() {
        // 1. Check if token is in URL (OAuth callback)
        if (window.location.hash.includes("access_token")) {
          const token = window.location.hash.match(/access_token=([^&]*)/)[1];
          localStorage.setItem("access_token", token);
          window.location.hash = ""; // Clean URL
        }

        // 2. If no token, redirect to login
        if (!this.getToken()) {
          const redirectUri = window.location.href.split('#')[0];
          window.location.href = `https://pike13.com/oauth/authorize?client_id=${CONFIG.clientId}&response_type=token&redirect_uri=${redirectUri}`;
          return false;
        }

        // 3. Ensure we have staff_id
        if (!localStorage.getItem("staff_id")) {
          this.fetchStaffId();
        }
        return true;
      },

      async fetchStaffId() {
        try {
          const res = await fetch(`${CONFIG.apiBase}staff_members/me`, {
            headers: { "Authorization": `Bearer ${this.getToken()}` }
          });
          const data = await res.json();
          if (data.staff_members && data.staff_members[0]) {
            localStorage.setItem("staff_id", data.staff_members[0].id);
            // Reload data after getting ID
            DataManager.loadForDate(STATE.currentDate);
          }
        } catch (e) {
          console.error("Auth Error", e);
        }
      }
    };

    /** * DATA SERVICE
     */
    const DataManager = {
      async loadForDate(date) {
        UI.showLoading(true);
        const staffId = localStorage.getItem("staff_id");
        if (!staffId) {
          // If staff ID is still missing, wait or retry logic could go here
          // For now, Auth.fetchStaffId handles it asynchronously
          UI.showLoading(false);
          return;
        }

        const token = Auth.getToken();
        const headers = { "Authorization": `Bearer ${token}` };
        const midnight = "00:00:00"; // Time handling simplification

        try {
          // Fetch Events and Available Times in parallel
          const [eventsRes, opensRes] = await Promise.all([
            fetch(`${CONFIG.apiBase}event_occurrences.json?from=${date}T${midnight}Z&staff_member_ids=${staffId}`, { headers }),
            fetch(`${CONFIG.apiBase}available_times.json?from=${date}T${midnight}Z`, { headers })
          ]);

          if (!eventsRes.ok) throw new Error("API Error");

          const eventsData = await eventsRes.json();
          const opensData = await opensRes.json();

          this.processData(eventsData, opensData);
          UI.render();
        } catch (error) {
          console.error(error);
          UI.showToast("Failed to load data. Please login again.", true);
          // Optional: clear token if 401
        } finally {
          UI.showLoading(false);
        }
      },

      processData(eventsData, opensData) {
        // Flatten logic from original getdata.js
        let result = [];

        // 1. Process Events
        if (eventsData.event_occurrences) {
            result = eventsData.event_occurrences.flatMap(event => 
                event.people.map(person => ({
                    id: person.id,
                    visitId: person.visit_id,
                    state: person.visit_state,
                    start: event.start_at,
                    end: event.end_at,
                    name: person.name,
                    service: event.service_name,
                    homeId: person.home_location_id,
                    isNew: person.new, // Assuming 'new' property exists or derived
                    // Calculate age if person details available (simplified for this structure)
                    // Note: original code fetched deeper person details here. 
                    // To keep it fast, we will rely on what's in event_occurrence or handle async if needed.
                    age: "N/A" 
                }))
            );
        }

        // Note: The original code did a second pass to fetch user details for AGE.
        // For performance in a single file, we are rendering what we have. 
        // If Age is critical, we would need to bulk fetch person details here.

        // 2. Filter exclusions
        result = result.filter(r => !CONFIG.excludedIds.includes(r.id));

        // 3. Sort by time
        result.sort((a, b) => new Date(a.start) - new Date(b.start));

        STATE.schedule = result;
      },

      async submitAttendance() {
        const token = Auth.getToken();
        const updates = Object.values(STATE.pendingAttendance);
        
        if(updates.length === 0) {
            UI.showToast("No changes to submit");
            return;
        }

        UI.showLoading(true);
        let successCount = 0;

        try {
            await Promise.all(updates.map(async (item) => {
                const url = `${CONFIG.apiBase}punches`;
                const body = JSON.stringify({ punch: { visit_id: item.visitId } });
                
                const res = await fetch(url, {
                    method: "POST",
                    headers: { 
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    },
                    body: body
                });
                if(res.ok) successCount++;
            }));
            
            UI.showToast(`Submitted ${successCount} records`);
            STATE.pendingAttendance = {}; // Clear pending
            this.loadForDate(STATE.dateInput.value); // Refresh
        } catch(e) {
            UI.showToast("Error submitting attendance", true);
        } finally {
            UI.showLoading(false);
        }
      },

      async resetAttendance() {
        // Find all currently visible visits
        const visits = STATE.schedule.filter(s => s.visitId);
        if(visits.length === 0) return;

        if(!confirm("Reset all attendance for today?")) return;

        UI.showLoading(true);
        try {
            await Promise.all(visits.map(v => 
                fetch(`${CONFIG.apiBase}visits/${v.visitId}`, {
                    method: "PUT",
                    headers: { 
                        "Authorization": `Bearer ${Auth.getToken()}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ visit: { state_event: "reset" } })
                })
            ));
            UI.showToast("Attendance Reset");
            this.loadForDate(STATE.dateInput.value);
        } catch(e) {
            UI.showToast("Error resetting", true);
        } finally {
            UI.showLoading(false);
        }
      }
    };

    /** * UI MANAGER
     */
    const UI = {
      init() {
        // Bind DOM Elements
        STATE.dateInput = document.getElementById("dateInput");
        
        // Set Initial Date
        STATE.dateInput.value = STATE.currentDate;

        // Event Listeners
        STATE.dateInput.addEventListener("change", (e) => {
            STATE.currentDate = e.target.value;
            DataManager.loadForDate(STATE.currentDate);
        });

        document.getElementById("prevDate").addEventListener("click", () => this.changeDate(-1));
        document.getElementById("nextDate").addEventListener("click", () => this.changeDate(1));

        // Navigation
        document.querySelectorAll(".nav-item").forEach(btn => {
            btn.addEventListener("click", (e) => {
                const target = e.currentTarget.dataset.target;
                this.navigate(target);
            });
        });

        // Actions
        document.getElementById("submitBtn").addEventListener("click", () => DataManager.submitAttendance());
        document.getElementById("resetBtn").addEventListener("click", () => DataManager.resetAttendance());

        // Initial Load
        if (Auth.init()) {
            DataManager.loadForDate(STATE.currentDate);
        }
      },

      changeDate(days) {
        const date = new Date(STATE.dateInput.value + "T00:00:00");
        date.setDate(date.getDate() + days);
        const newDateStr = date.toISOString().split('T')[0];
        STATE.dateInput.value = newDateStr;
        STATE.currentDate = newDateStr; // Update state
        DataManager.loadForDate(newDateStr);
      },

      navigate(viewName) {
        STATE.view = viewName;
        
        // Update Nav Buttons
        document.querySelectorAll(".nav-item").forEach(b => b.classList.remove("active"));
        document.querySelector(`.nav-item[data-target="${viewName}"]`).classList.add("active");

        // Update View Visibility
        document.querySelectorAll(".view-section").forEach(el => el.classList.add("hidden"));
        document.getElementById(`view-${viewName}`).classList.remove("hidden");

        // Update Header
        document.getElementById("pagePill").textContent = viewName === 'schedule' ? 'Overview' : 'Actions';
        document.getElementById("pageTitle").textContent = viewName.charAt(0).toUpperCase() + viewName.slice(1);

        this.render(); // Re-render to ensure fresh data
      },

      render() {
        if (STATE.view === 'schedule') {
            this.renderScheduleTable();
        } else {
            this.renderAttendanceTable();
        }
      },

      // Helper to group consecutive slots
      groupScheduleData() {
        const data = STATE.schedule;
        if (!data.length) return [];

        const grouped = [];
        // Deep copy first item to start
        let currentGroup = { ...data[0], names: [data[0].name], levels: [data[0].service] }; 
        
        for (let i = 1; i < data.length; i++) {
            const item = data[i];
            const prev = data[i-1];
            
            // Logic: If same person, same service, and times touch
            if (item.id === prev.id && item.service === prev.service && item.start === prev.end) {
                // Extend the block
                currentGroup.end = item.end;
            } else if (item.start === currentGroup.start) {
               // Same time block, different person (Concurrent lesson?)
               // For this app's logic based on previous code, we just list them.
               // Simple grouping by time logic:
               grouped.push(currentGroup);
               currentGroup = { ...item, names: [item.name], levels: [item.service] };
            } else {
               grouped.push(currentGroup);
               currentGroup = { ...item, names: [item.name], levels: [item.service] };
            }
        }
        grouped.push(currentGroup);
        return grouped;
      },

      formatTime(isoString) {
        const date = new Date(isoString);
        return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
      },

      renderScheduleTable() {
        const tbody = document.getElementById("scheduleBody");
        tbody.innerHTML = "";

        if (STATE.schedule.length === 0) {
            tbody.innerHTML = `<tr><td colspan="3" style="text-align:center; color:var(--muted)">No lessons for this day</td></tr>`;
            return;
        }

        // We use the raw list for simple schedule list, or grouped if preferred. 
        // Based on original code, we want to see every slot or grouped by person.
        // Let's stick to a clean chronological list for clarity.
        
        STATE.schedule.forEach(item => {
            const duration = (new Date(item.end) - new Date(item.start)) / 60000;
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td style="white-space:nowrap; font-weight:600;">
                    ${this.formatTime(item.start)}<br>
                    <span style="font-size:0.8em; color:var(--muted); font-weight:400;">${duration} min</span>
                </td>
                <td>
                    <span class="name-text">${item.name}</span>
                    <div class="sub-text">${item.service}</div>
                </td>
                <td>
                    ${item.isNew ? '<span style="color:var(--green); font-weight:bold; font-size:0.75rem">NEW</span>' : ''}
                    <!-- Age would go here if available -->
                </td>
            `;
            tbody.appendChild(tr);
        });
      },

      renderAttendanceTable() {
        const tbody = document.getElementById("attendanceBody");
        tbody.innerHTML = "";
        STATE.pendingAttendance = {}; // Clear pending on re-render

        if (STATE.schedule.length === 0) {
            tbody.innerHTML = `<tr><td colspan="2" style="text-align:center;">No lessons</td></tr>`;
            return;
        }

        STATE.schedule.forEach(item => {
            const tr = document.createElement("tr");
            
            // Check button state
            const isCompleted = item.state === "completed";
            const isLateCancel = item.state === "late_canceled";
            
            tr.innerHTML = `
                <td style="width: 80px; font-weight:600;">${this.formatTime(item.start)}</td>
                <td>
                    <div style="display:flex; align-items:center; justify-content:space-between;">
                        <div>
                            <span class="name-text">${item.name}</span>
                            <span class="sub-text">${item.state || 'scheduled'}</span>
                        </div>
                        <button class="attendance-btn ${isCompleted ? 'active' : ''}" 
                                onclick="UI.toggleAttendance(this, '${item.visitId}')">
                           <i class="ph ph-check"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
      },

      toggleAttendance(btn, visitId) {
        // Visual Toggle
        const isActive = btn.classList.contains("active");
        
        if (isActive) {
            btn.classList.remove("active");
            // If we deselect, we might want to queue a reset or just remove from pending
            // For simplicity, we just remove from pending "completed" list
            delete STATE.pendingAttendance[visitId];
        } else {
            btn.classList.add("active");
            STATE.pendingAttendance[visitId] = { visitId, status: 'complete' };
        }
      },

      showLoading(isLoading) {
        const el = document.getElementById("loading");
        if(isLoading) el.classList.remove("hidden");
        else el.classList.add("hidden");
      },

      showToast(msg, isError = false) {
        const t = document.getElementById("toast");
        t.textContent = msg;
        t.style.background = isError ? "var(--red)" : "var(--ink)";
        t.classList.add("show");
        setTimeout(() => t.classList.remove("show"), 3000);
      }
    };

    /** * PULL TO REFRESH LOGIC 
     */
    let pullStartY = null;
    window.addEventListener("touchstart", (e) => {
        if (window.scrollY === 0) pullStartY = e.touches[0].clientY;
    }, { passive: true });

    window.addEventListener("touchmove", (e) => {
        if (!pullStartY) return;
        const delta = e.touches[0].clientY - pullStartY;
        if (delta > 80) document.body.classList.add("pull-refresh-ready");
        else document.body.classList.remove("pull-refresh-ready");
    }, { passive: true });

    window.addEventListener("touchend", () => {
        if (document.body.classList.contains("pull-refresh-ready")) {
            location.reload();
        }
        document.body.classList.remove("pull-refresh-ready");
        pullStartY = null;
    }, { passive: true });

    // Start App
    document.addEventListener("DOMContentLoaded", () => UI.init());

  </script>
</body>
</html>
